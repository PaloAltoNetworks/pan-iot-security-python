import unittest

from . import mixin


class IotApiTest(mixin.Mixin, unittest.TestCase):
    def test_01(self):
        resp = self.api.vulnerability(pagelength=0)
        self.assertEqual(resp.status_code, 400)

        resp = self.api.vulnerability(groupby='x-invalid')
        self.assertEqual(resp.status_code, 400)

    def test_02(self):
        resp = self.api.vulnerability(groupby='device',
                                      pagelength=1)
        self.assertEqual(resp.status_code, 200)
        x = resp.json()
        self.assertIn(x['total'], (0, 1))
        self.assertIn(len(x['items']), (0, 1))

    def test_03(self):
        for groupby in (None, 'vulnerability'):
            # pagelength ignored
            resp = self.api.vulnerability(groupby=groupby,
                                          pagelength=1)
            self.assertEqual(resp.status_code, 200)
            x = resp.json()
            self.assertGreaterEqual(x['total'], 0)
            self.assertGreaterEqual(len(x['items']['items']), 0)

    def test_04(self):
        total = 0
        for ok, x in self.api.vulnerabilities_all(groupby='device'):
            self.assertTrue(ok)
            total += 1
            if total > 1050:
                break
